# コピーまとめ

基本的には `cp`、複雑なコピーをしたいときは `rsync` を使う。  
`rsync` でできて `cp` でできないことの例は以下の通り。  

- リモートでコピー
    - コピー元もしくはコピー先のパスを `user@host:/path/want/to/copy` のようにする
- 差分のみコピー
    - デフォルトの挙動
- コピー元のファイル削除をコピー先にも反映（ミラーリング）
    - `--delete` オプションを付ける
    - 事故が起きやすいので `--dry-run` もしくは `-n` で内容を確認してから実行することを推奨


## パフォーマンス

`rsync` はファイルごとに差分をチェックするので、基本的には `cp` より遅い。  
特にファイル数が多いとその傾向が強くなる。

ただし、大容量ファイルの場合は差分のみコピーすることで速くなるケースがあるので、その場合は `rsync` のほうが速い。


## おすすめのオプション

`cp` を使う場合は `-iav` オプションを付けておくと良い。

- `i`
    - 上書きする前に確認するプロンプトが表示される
- `a`
    - サブディレクトリや属性などをできるだけ保持する
    - `-dR --preserve=all` と同じ
- `v`
    - 結果を出力する
- `d`
    - シンボリックリンクをそのままコピーする
    - `--no-dereference --preserve=links` と同じ
- `R`
    - サブディレクトリも再帰的にコピーする
- `--preserve=all`
    - パーミッション、オーナー、タイムスタンプなどすべての属性をコピーする
- `--no-dereference`
    - シンボリックリンクをたどらないでコピーする

`rsync` を使う場合は `-aPvh` オプションを付けておくと良い。

- `a`
    - `cp` の `a` オプションと同様
- `P`
    - 中断した場合にファイルを保持し、進行状況を表示する
    - `--partial --progress` と同じ
- `--partial`
    - 中断した場合にファイルを保持する
- `--progress`
    - 進行状況を表示する
- `v`
    - `cp` の `v` オプションと同様
- `h`
    - 数字を見やすい単位で表示する


## rsyncの注意点

rsyncでフォルダをコピーするときに、コピー元の末尾に `/` がついているかどうかで挙動が変わる。

`rsync -r foo bar` のように `/` がついていないときは `bar` フォルダの中に `foo` フォルダがコピーされる。  
`rsync -r foo/ bar` のように `/` がついているときは `bar` フォルダの中に `foo` フォルダの中身がコピーされる。

なお、`cp` では `/` の有無によらず、`bar` フォルダの中に `foo` フォルダがコピーされる。


## 上書き時にバックアップ

### cp

`--backup` もしくは `-b` オプションを使うと、最新のものがオリジナルのファイル名、1つ前のものが末尾に `~` のついたファイル名で保持される。  
2つ以上前のバージョンは保持されない。

`` --backup --suffix=.`date +%Y%m%d_%H%M%S` `` のようにすると、末尾を `~` ではなくタイムスタンプにできる。  
毎回末尾が変わるので2つ以上前のバージョンも保持される。

環境変数の `SIMPLE_BACKUP_SUFFIX` が設定されていると、`--suffix` オプションを指定しなくても自動的にその値で設定される。  
なお、この環境変数は `mv` や `ln` コマンドなどにも適用される。

`--backup=numbered` もしくは `--backup=t` オプションを使うと、最新のものがオリジナルのファイル名、1つ前のものが末尾に `.~1~` のついたファイル名で保持される。  
繰り返すたびに数字がインクリメントされながらすべてのバージョンが保持される。  
新しいものほど数字が大きい。  
`--suffix` オプションや `SIMPLE_BACKUP_SUFFIX` の環境変数は無視される。


### rsync

`cp` と同様に `--backup` もしくは `-b` オプションが使える。  
仕様も同様。  
ただし `--backup=numbered` もしくは `--backup=t` オプションは使えない。  
`--suffix` オプションは同様に使えるが、環境変数の `SIMPLE_BACKUP_SUFFIX` は参照しない。

`rsync --backup --backup-dir=foo bar baz` のようにすると、最新のものが `baz/bar`、1つ前のものが `baz/foo/bar` に保持される。  
`` --backup-dir=`date +%Y%m%d_%H%M%S` `` のようにすればフォルダ名が毎回変わるので、すべてのバージョンをバージョンごとのフォルダで保持できる。  
ただし上書きされないファイルはバックアップフォルダに保持されない。  
`--suffix` オプションと組み合わせた場合、バックアップフォルダ内に指定した末尾のファイル名で保持される。


## 増分バックアップ

```sh
function incr_bak() {
  local base="$2"

  mkdir "${base}"

  local latest="../$(\ls ${base} | tail -n 1)"

  rsync --link-dest="${latest}" "$1" "${base}/$(date +%Y%m%d_%H%M%S)"
}
```

上のような関数を用意して `incr_bak foo bar` を実行すると `bar/yyyyMMdd_HHMMss/foo` が作成される。  
タイムスタンプの部分が毎回変わるので、すべてのバージョンをバージョンごとのフォルダで保持できる。  
また、上書きされないファイルもバックアップフォルダに保持される。  
その際、上書きされたものは別のinode、されなかったものは同じinodeでハードリンクされるので、最小限の容量で済む。

なお、`--link-dest` に渡すフォルダを固定にすると増分バックアップではなく差分バックアップになる。


## ドライラン

`rsync` は `--dry-run` もしくは `-n` オプションでドライランできる。  
つまり、実行結果を反映させずに確認できる。
