# APIの認証

Cookieを使う方法とトークンをヘッダやクエリに含める方法がある。  
トークンを使うほうがシンプルで済むことが多い。

Cookieを使う場合は状況によって対応が変わる。

- クライアントのオリジンが固定でサーバと同じ
    - 特別な対応不要
- クライアントのオリジンが固定でサーバと異なる
    - サーバ側の対応
        - レスポンスヘッダの `Access-Control-Allow-Origin` にクライアントのオリジンを設定する
        - レスポンスヘッダの `Access-Control-Allow-Credentials` に `true` を設定する
        - `Set-Cookie` の `SameSite` 属性に `None` を設定する
        - `Set-Cookie` に `Secure` 属性を設定する
        - HTTPSを使う
    - クライアント側の対応
        - リクエストに認証情報を含める
            - `fetch` であればオプションに `{credentials: "include"}` を設定する
- クライアントのオリジンが不定
    - 「クライアントのオリジンが固定でサーバと異なる」の対応に加えて、レスポンスヘッダの `Access-Control-Allow-Origin` にクライアントのオリジンを動的に設定すれば可能
    - ただし、CSRF脆弱性があるのでNG

トークンを使う場合はアクセストークンとリフレッシュトークンに分けることでリスクを減らす。  
[アクセストークンとリフレッシュトークン](./%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%A8%E3%83%AA%E3%83%95%E3%83%AC%E3%83%83%E3%82%B7%E3%83%A5%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3.md) も参照。  
トークンは WebStorage などに保存する。

クライアント側でログイン状態を検証したい場合は、秘密鍵で署名したJWTを使い、公開鍵で検証する。(JSON Web Signature; JWS)  
期限が切れている場合はリフレッシュトークンでのリフレッシュが必要。  
クライアント側は秘密鍵が無いので署名ができない。  
これによってログインしていないのにダミーのJWTを持っていたり、期限を長めに改ざんしたりすると検証が失敗するので、不正なログイン状態を防げる。

JWTの仕組みは下のサイトがわかりやすい。  
https://assets.ctfassets.net/2ntc334xpx65/5HColfm15cUhMmDQnupNzd/30d5913d94e79462043f6d8e3f557351/jwt-handbook-jp.pdf

JWTが漏洩した場合でも不正利用を防ぐには、JSON Web Encryption (JWE) や Token Binding という仕組みを使えば良い。  
詳しくは上のリンクに記載されているが、JWSと逆に各ユーザがそれぞれの秘密鍵で署名し、サーバに登録しておいた対応する公開鍵で検証する。  
これにより秘密鍵が漏洩しなければJWTが漏洩しても不正利用を防げる。
