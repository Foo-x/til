# サーキットブレーカー

リクエストの受信側が過負荷などでレスポンスが遅くなったり落ちていたりする場合を考える。  
このとき、送信側はタイムアウトまで処理が止まるので、できる限り早くエラーを返してほしい。  
また、受信側はさらに負荷がかかるのを防ぐため、なるべくリクエストしてほしくない。  
これらを解決する方法として、両者の間にサーキットブレーカーを置く方法がある。

サーキットブレーカーは以下の3つの状態を持つ。

- クローズド
    - リクエストを受信側に送信し、レスポンスを送信側に返す
    - リクエストが閾値を超えるだけ繰り返し失敗した場合、オープン状態に遷移する
- オープン
    - リクエストを受信側に送信せず、エラーを送信側にすぐ返す
    - ある程度時間が経ったらハーフオープン状態に遷移する
- ハーフオープン
    - リクエストの一部を受信側に送信し、レスポンスを送信側に返す
        - 閾値を超えるだけ成功した場合、クローズド状態に遷移する
        - 失敗した場合、オープン状態に遷移する

受信側に障害が発生している間、サーキットブレーカーはオープン状態になる。  
このとき、リクエストはサーキットブレーカーで止まるため、受信側には届かず、送信側はすぐにエラーを受け取れる。

参考

- [サーキットブレーカーパターン - AWS 規範ガイダンス](https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/cloud-design-patterns/circuit-breaker.html)
- [サーキット ブレーカー パターン - Azure Architecture Center | Microsoft Learn](https://learn.microsoft.com/ja-jp/azure/architecture/patterns/circuit-breaker)

関連

- [信頼性](../quality/信頼性.md)
    - フェールソフト（グレースフルデグラデーション）を実現できる
- [BackpressureとLoadShedding](../network/BackpressureとLoadShedding.md)
    - 受信側の負荷を減らせる
