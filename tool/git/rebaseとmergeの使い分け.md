# rebaseとmergeの使い分け

## 前提

```mermaid
graph LR
    1[1]
    2[2]
    3[3]
    4["4[分岐元ブランチ]"]
    5[5]
    6["6[操作対象ブランチ]"]

    1 --> 2 --> 3 --> 4
    2 --> 5 --> 6
```

rebaseとは、ブランチの分岐元を移動すること。  
以下は操作対象ブランチを分岐元ブランチの最新のコミットにrebaseした例。

```mermaid
graph LR
    1[1]
    2[2]
    3[3]
    4["4[分岐元ブランチ]"]
    5[5]
    6["6[操作対象ブランチ]"]

    1 --> 2 --> 3 --> 4 --> 5 --> 6
```

mergeとは、ブランチ間の差分を表すコミットを追加して統合すること。  
以下は操作対象ブランチを分岐元ブランチにmergeした例。

```mermaid
graph LR
    1[1]
    2[2]
    3[3]
    4[4]
    5[5]
    6["6[操作対象ブランチ]"]
    7["7[分岐元ブランチ]"]

    1 --> 2 --> 3 --> 4 --> 7
    2 --> 5 --> 6 --> 7
```

squash and merge とは、ブランチ間の差分を表すコミットを新しく作成すること。  
以下は操作対象ブランチを分岐元ブランチに squash and merge した例。

```mermaid
graph LR
    1[1]
    2[2]
    3[3]
    4[4]
    5[5]
    6["6[操作対象ブランチ]"]
    7["7[分岐元ブランチ]"]

    1 --> 2 --> 3 --> 4 --> 7
    2 --> 5 --> 6
```

rebase and merge とは、ブランチ間の差分だけコミットを追加すること。  
以下は操作対象ブランチを分岐元ブランチに rebase and merge した例。

```mermaid
graph LR
    1[1]
    2[2]
    3[3]
    4[4]
    5[5]
    6["6[操作対象ブランチ]"]
    5'[5']
    6'["6'[分岐元ブランチ]"]

    1 --> 2 --> 3 --> 4 --> 5' --> 6'
    2 --> 5 --> 6
```

git flow のmasterやdevelopおよび GitHub flow のmasterをメインブランチと呼び、それ以外をサポートブランチと呼ぶ。


## 方針

以下の方針で使い分ける。

- サポートブランチから git flow のdevelopや GitHub flow のmasterにマージする -> squash and merge
    - コミットログが見やすい
    - レビュー対応コミットのようなノイズが無くなる
    - 1プルリクエスト1コミットなのでrevertしやすい
- git flow のdevelopからmasterにマージする場合など、同じブランチ間で同じ方向に複数回マージする -> merge
    - それ以外の方法だとマージ元のブランチにマージした履歴が残らないので、2回目のマージ時にコンフリクトが発生する
- すでにプルリクエストを作成したサポートブランチに分岐元ブランチの最新のコミットを取り込む -> merge
    - rebaseして force push すると過去のレビューが紐づかなくなる
- ローカルで開発中のサポートブランチに分岐元ブランチの最新のコミットを取り込む -> rebase
    - コミットログが見やすくなるのでレビューしやすい
