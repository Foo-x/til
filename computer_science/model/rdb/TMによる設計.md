# TMによる設計

Theory of Models (TM) はコッドの正規形に対して意味論を拡張したモデル。これによってデータベース設計だけでなく、データモデルによる事業分析も可能にする。

6つの作業を行う。

1. モノの集まり（「集める」技術）
2. モノの並び（「並べる」技術）
3. 「関係」文法
4. セット（集合）
5. 多値関数
6. クラス

5.までが構文論、6.が意味論の作業。

なお、ここでいう構文論 (syntax) とは記号の演算のことで、意味論 (semantics) とは構文論に実際の値を充足して解釈すること。

TMの前身にT字型ER法というものがあった。これはコッドの正規形を補う技術を実際の経験をもとに体系化したもの。  
理論的な裏付けがなかったこと、多値のAND関係を説明できなかったことの問題があった。  
TMではそれを解決している。


## モノの集まり

TMではモノを、個体指定子を付与されている対象と定義している。  
個体指定子というのはたとえば従業員番号、部門コード、受注番号、契約番号など。  
いくつかの項目を代表しているモノに対して、情報をやり取りしやすくするために付与される。

なお、区分コードは個体指定子ではない。  
個体指定子が集合を表すのに対して、区分コードはその部分集合にあたるため。

モノを生成する手順は以下の通り。

1. 情報ごとにT字の書式（仕訳帳）を作る
    - ここでいう情報は画面などの単位
    - この図を TMD (TM Diagram) という
2. Tの上に情報の名前を入れる
3. Tの左に情報の個体指定子を入れる
4. Tの右に情報の個体指定子以外の項目を入れる
5. 個体指定子ごとに箱（T字書式）を作る
6. 元のT字書式の右に入れた項目を、適切な箱に入れる

ポイントは、1つの箱には1つの個体指定子のみが入ること、個体指定子以外の項目はあとで整理するのでとりあえず良さそうな箱に入れておけば良いことの2つ。  
また、この時点では個体指定子が一意かどうかを気にしなくて良い。

なお、個体指定子もそれ以外の項目も、ユーザ言語をそのまま使う。ユーザ言語にない語彙を勝手に増やさない。


## モノの並び

まずモノをEventとResourceに分ける。

- Event
    - 生成条件が日付であるモノ
    - 以下は生成条件でない日付
        - 出来事の結果として生起した日付
            - たとえば従業員に入社日が紐づいていても、従業員はEventではない。「入社」というEventが隠れていて、入社日はそちらの項目に入る
        - データを管理するための将来の日付
            - 有効期限など
        - データを管理するための過去の日付
            - 更新日など
- Resource
    - Eventでないモノ

「モノの集まり」で作ったT字書式の右上に、EventはE、ResourceはRと書いておく。

次に、先行-後続関係にあるEvent同士を横に並べる。先行-後続関係にないEvent同士は縦に並べる。

その後、Eventの上下にResourceを適当に並べる。場所はどこでも良いが、多くのEventに関係するResourceは中央付近に置くと、このあとの線でつなげる作業をやりやすい。


## 「関係」文法

ここでは箱同士の関係を表すために線でつなげる。  
関係の組み合わせは以下の通り。

- (Event, Resource)
    - 出来事にモノが関与する
- (Event, Event)
    - 先行-後続関係になる
- (Resource, Resource)
    - モノとモノから新しいモノを作る
- 再帰
    - 1つのモノからいくつか選んで並べる

T字書式の箱同士を線でつなぎ、ER図のIE記法（Crow's Foot 記法）のようにオプショナリティやカーディナリティの記号を記入する。

- オプショナリティ
    - 対応する値がない可能性がある場合は〇
- カーディナリティ
    - 1つのみ対応する場合は|
    - 複数対応する場合はカラスの足

関係が網羅されているかを検証するには、すべての情報をマトリックスで縦と横に並べて、作った関係にチェックを付けていけば良い。


### (Event, Resource) 関係

Eventの箱の左側にResourceの個体指定子を加える。このとき、(R) の記号を付ける。このRはResourceのRではなく、RelationのR。

たとえば、顧客番号の個体指定子を持つResouceと受注のEventをつないだとき、受注の箱の左側に「顧客番号 (R)」を加える。


### (Event, Event) 関係

先行Eventのカーディナリティが1の場合、先行Eventの個体指定子を後続Eventの箱の左側に (R) の記号とともに加える。

先行Eventのカーディナリティが複数の場合、対応表の箱を作る。  
Event間の線の途中に〇を記入し、そこから分岐するように対応表の箱とつなげる。  
対応表の箱の左側には両方のEventの個体指定子が (R) の記号とともに入る。  
右側にはその他の項目を入れる。


### (Resource, Resource) 関係

(Event, Event) 関係の対応表と同様にして対照表を作る。


### 再帰関係

再帰表の箱を作り、Resourceとつなげる。このときカーディナリティは両側とも複数になるのでカラスの足を記入する。  
Resourceと再帰表の線の途中に〇を記入し、そこから分岐するようにResourceの箱とつなげる。（Resourceの箱から2本の線が出ることになる）  
再帰表の箱の左側にはResourceの個体指定子を (R) の記号とともに2つ記入する。  
右側にはその他の項目を入れる。


## セット

セット（集合）がサブセット（部分集合）に切断されるのは2パターンある。

- 実質的サブセット
    - 区分コードで切断
- 形式的サブセット
    - 項目の一部にnullが発生するのを回避するために切断

サブセットの箱を作り、元の箱から線を分岐させてつなげる。  
サブセットの箱の個体指定子はスーパーセットと同じになる。

サブセットは排他的ORになっている必要がある。  
AND関係になる場合はサブセットではなく対照表で対応する。  
つまり、元の箱から区分コードを削除し、代わりに区分の箱を作る。  
元の箱と区分の箱を対照表でつなげる。

区分コードが複数ある場合は多階層になる。  
その際、セットとサブセットの関係上、上下の階は入れ替え不可能。  
入れ替えても問題ないように見える場合は区分が不適切なので、対照表で対応する。  
不適切な区分はモノに帰属しない。


## 多値関数

### 多値のOR

1つのモノに同じ項目が複数紐づくが、同時には成立しないときは多値のOR関係。  
たとえばある商品に正価格と割引価格が存在する場合などがある。

このときは元の箱の個体指定子をRelationとして持つ箱を作成し、元の箱とつなげる。  
新しい箱には項目として種別コードが含まれる。


### 多値のAND

1つのモノに同じ項目が複数紐づき、同時に成立するときは多値のAND関係。  
たとえば1度の受注で複数の商品とその受注数が存在する場合などがある。

このときはHDRの箱とDTLの箱を作ってつなげる。  
両方とも同じ個体指定子を持つ。（実装する際は親のテーブルで個体指定子を持ち、HDRとDTLではRelationとして持つことになる）


## クラス

クラスは個体指定子と項目で別々に適用する。  
個体指定子に適用するのはサブセットの作成と同様なので省略する。

項目にクラスを適用するのはEventとResourceを意味論的に整えるため。  
検討すべきは4つ。

- ResourceにEventの性質が混入している
- Resourceに他のResourceの性質が混入している
- EventにResourceの性質が混入している
- Eventに他のEventの性質が混入している

これらの箱がある場合は、混入している項目を別の箱に分ける。  
新しい箱は元の箱の個体指定子をRelationとして持つ。


## 参考

- [事業分析・データ設計のためのモデル作成技術入門](https://www.amazon.co.jp/dp/B0B6MTN4JX)
